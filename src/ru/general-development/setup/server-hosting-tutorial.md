# Хостинг для
Разместить локальный сервер-песочницу для игры несложно, но создать большой производственный сервер, поддерживающий сотни игроков, немного сложнее. Это руководство разбито на «уровни», соответствующие сложности.

## Level 0: Локальная Песочница

```admonish danger title="НЕ МОДИФИЦИРУЙТЕ ПАПКУ RESOURCES В ПРЕДВАРИТЕЛЬНО СКОМПИЛИРОВАННЫХ СЕРВЕРАХ"
Действительно не стоит, это не сработает. Попытка сделать это в любом случае приведет к **отказу от поддержки**.
Единственные изменения, которые вы можете внести в упакованную сборку сервера - это файл ``server_config.toml`.
Если вы хотите модифицировать свой сервер и добавить в него собственное содержимое. Вам понадобится [соответствующая среда разработки](./setting-up-a-development-environment.md) с вашими изменениями, а затем [сбилдить вашу собственную сборку](#level-2-server-with-custom-code).
```

1. Скачайте и установите [.NET 8 Runtime](https://dotnet.microsoft.com/ru-us/download/dotnet/8.0). Вам нужен только «x64» в разделе «run console apps», а не «hosting bundle» со страницы загрузок.
2. Скачайте последнюю версию сервера с [нашей страницы сборок](https://wizards.cdn.spacestation14.com/fork/wizards), для вашей операционной системы. Если вы ищете другой форк, спросите его, есть ли у него страница с готовой сборкой сервера. В противном случае обратитесь к разделу [Custom Code](#level-2-server-with-custom-code) ниже.
3. Распакуйте это в какую-нибудь директорию.
4. Запустите `run_server.bat` (Windows) или `Robust.Server` [через терминал на macOS/Linux](#running-the-server-on-macos-or-linux))
5. Откройте Space Station 14 Launcher и нажмите на ``Прямое подключение к серверу``, введите ``localhost`` и нажмите кнопку подключения. Вы также можете добавить его в избранное, если нажмете кнопку ``Добавить в избранное``.
6. Когда появится новое обновление. Вернитесь ко второму шагу и скопируйте папку ``data`` и ``server_config.toml``, если вы его изменяли.

Если вы предпочитаете видеоинструкции, [вот одна из них](https://youtu.be/IDBqrAGZ3cA)!

## Уровень 1: Играем с друзьями
Если вы хотите, чтобы другие люди могли подключиться и играть, вам нужно будет выполнить несколько дополнительных действий.

### Переадресация портов

Чтобы люди могли подключаться к серверу, необходимо открыть сетевые порты. По умолчанию игровой сервер использует два порта:
* UDP `1212` используется для основного игрового неткода. Он необходим для того, чтобы *клиент* мог подключиться к серверу. Его можно настроить с помощью переменной конфигурации `net.port`.
* TCP `1212` - это API статуса HTTP. Он также необходим для того, чтобы *лаунчер* мог подключиться к серверу. Для соединения с голым клиентом он не нужен. Это можно настроить с помощью конфигурационной переменной `status.bind` (которая принимает строку типа `*:1212` или `127.0.0.1:3000`).

Для получения дополнительной информации о том, как открыть порты, см: [Port Forwarding](../../server-hosting/port-forwarding.md)

После переадресации портов вы можете использовать [этот сайт](https://www.whatismyip.com/), чтобы получить свой публичный IP-адрес. Если у вас есть IPV4 и IPV6, попробуйте оба, если один из них не работает.

Дайте это своим друзьям и попросите их подключиться к нему напрямую. Если проброс портов был выполнен правильно, они должны иметь возможность подключиться.

```admonish info
Если у вас есть IPV6-адрес (выглядит примерно так ``fd11:5ee:bad:c0de::ab3:3d03``), убедитесь, что в меню прямого подключения указаны квадратные скобки (``[fd11:5ee:bad:c0de::ab3:3d03]``).
```

 
### Настройте ваш сервер

Вы можете настроить параметры сервера, отредактировав файл конфигурации, `server_config.toml`. Конфигурационный файл - это TOML, который по сути является INI ~~за исключением того, что он лучше специфицирован, несколько мощнее, его легче использовать не по назначению и он более раздражающе настроен (комментарии не имеют своей собственной строки)~~.

Настройки имеют один ключ, под который они попадают, а затем имя. Так что если я скажу `game.lobbyenabled`, то это будет под заголовком `[game]`, например:
```toml
[game]
lobbyenabled = true
```

Понятно? Хорошо.

**Некоторые разумные значения по умолчанию, которые вы, возможно, захотите установить для своего сервера, если вы действительно собираетесь разместить это должным образом:**

```admonish warning
Пожалуйста, прочтите комментарии здесь, чтобы вы хорошо понимали, что вы делаете.
```

```toml
[net]
# Уменьшение тикрейта до 30 практически незаметно.
# но значительно снижает нагрузку на сервер, клиентов и сеть.
tickrate = 30

[game]
# Изменяет имя сервера, отображаемое в лобби и пусковой установке.
hostname = «Foo Station»
# Включает лобби вместо того, чтобы сразу бросать клиентов в игру.
lobbyenabled = true

[auth]
# Обеспечивает аутентификацию, так что ВСЕ подключающиеся клиенты должны иметь соответствующую учетную запись.
# В противном случае разрешены гостевые логины.
# Возможные значения: 0 (необязательно), 1 (обязательно), 2 (отключено)
режим = 1
```

Несколько более подробное руководство по настройке сервера см. в [Config File Reference](../tips/config-file-reference.md).

 
### Привилегии администратора

По умолчанию привилегии администратора не установлены. Привилегированный администратор может раздавать права другим администраторам с помощью консольной команды `permissions` в игре, но в этом случае возникает проблема курицы и яйца. Чтобы получить начальные права администратора `+HOST` на вашем сервере, вы можете использовать один из следующих трех методов:

```admonish danger
Привилегии `+HOST` предоставлять **очень опасно**, и их следует давать только тем людям, у которых уже есть доступ к вашему компьютеру или серверу.

**Давая кому-то `+HOST`, он может полностью захватить ваш сервер и/или компьютер.** 
```

* Если вы подключаетесь к игровому серверу через localhost (IP `127.0.0.1` или `::1`), игра автоматически предоставит вам полные привилегии хоста. Это можно отключить с помощью параметра `console.loginlocal` CVar.
* Если вы установите в CVar `console.login_host_user` ваше имя пользователя, то при подключении вам будет предоставлен хост.
* Вы можете использовать команду `promotehost` из консоли сервера (например, `promotehost PJB`) для временного предоставления хоста подключенному клиенту.

## Уровень 2: Сервер с пользовательским кодом
Чтобы создать сборку сервера с пользовательским кодом, необходимо [настроить среду разработки](./setting-up-a-development-environment.md). После этого вам нужно сгенерировать сборку сервера, запустив ее:

Сначала вы билдите инструмент упаковки, используя:

`dotnet build Content.Packaging --configuration Release`.

Затем вы можете использовать Content.Packaging для выполнения сложной работы. Команда ниже упакует сервер с помощью hybrid-acz (чтобы программа запуска могла загружать ваш пользовательский контент) для систем linux. Если вы хотите сделать это для Windows, замените ``linux-x64`` на ``win-x64``.

`dotnet run --project Content.Packaging server --hybrid-acz --platform linux-x64`

```admonish info
Обратите внимание, что если вы используете более старый сервер, на котором данная система не была реализована, или вам нужно использовать устаревший скрипт (больше не поддерживается), то вместо этого используйте следующее
`python Tools/package_server_build.py --hybrid-acz`
```

Проверьте папку `release/` на наличие упакованного сервера для вашей пользовательской кодовой базы.

## Уровень 3: «Производственный» сервер

Разумеется, он не будет делать автоматические перезагрузки (в случае чего) или обновления, как это делает Watchdog. Он также не будет публично публиковать ваш сервер на хабе, так как публикация в хабе по умолчанию отключена. Если вы хотите, чтобы ваш сервер был опубликован на хабе, прочтите статью `Public Hub Server` ниже.

Для других сервисов, таких как `SS14.Watchdog`, вам также потребуется [ASP .NET Core 8 Runtime](https://dotnet.microsoft.com/ru-us/download/dotnet/8.0) (входит в .NET 8 SDK).

### Установка правил
По умолчанию сервер поставляется без правил. Чтобы установить пользовательские правила для своего сервера, выполните следующие действия:

1. Форкните проект, если вы этого еще не сделали (что означает также [setting up development environment](./setting-up-a-development-environment.md)).
2. Добавьте файл-путеводитель с вашими правилами в директорию `Resources/ServerInfo/Guidebook/ServerRules`. Придерживайтесь формата `DefaultRules.xml`.
3. Добавьте запись прототипа справочника в `Resources/Prototypes/Guidebook/rules.yml`. Укажите на созданный вами текстовый файл путеводителя.
4. Установите CCVar `server.rules_file` в ID, который вы задали в прототипе справочника, созданном на предыдущем шаге.

### Public Hub Server - Получение вашего сервера в списке программы запуска

1. Прочитайте [правила хаба](../../community/space-wizards-hub-rules.md), прежде чем размещать свой сервер в нём. Размещение в хабе означает согласие с его правилами.

2. Выберите теги для своего сервера на основе [стандартных тегов](../../robust-toolbox/server-http-api.md#standard-tags).

3. Добавьте следующие строки в [конфигурацию сервера](../tips/config-file-reference.md):

    ```toml
    [hub]
    advertise = true
    # Чтобы изменить URL-адрес сервера, показываемый в списке основных серверов.
    # Используйте это, если вам нужен ss14s:// URL или вы настроили сервер за обратным прокси или что-то в этом роде.
    # По умолчанию «ss14://[IP-адрес публичного сервера]:сетевой порт»
    # server_url = «ss14://...»
    tags = «» # список тегов, разделенных запятыми
    ```
Если при попытке размещения сервера в хабе вы получаете ошибку, прочтите [раздел по устранению неполадок](#Troubleshooting)

### Конфигурация сборки сервера

Если вы захотите создать более постоянный сервер, вам придется где-то разместить клиентские загрузки. Подойдет любое место, доступное по обычному URL.

Вам нужно будет отредактировать файл конфигурации сервера (`server_config.toml) и добавить в него следующее:

```toml
[build]
# Загружать местоположение всей сборки клиента в zip-архиве в виде HTTP (или HTTPS) URL.
download_url = «»
```

### Настройки производительности

Вот некоторые настройки, которые вы, вероятно, захотите включить на своем сервере для повышения производительности:

Переменная окружения для включения полного динамического PGO, что значительно повышает производительность ценой незначительного увеличения времени запуска:
```
DOTNET_TieredPGO: 1
DOTNET_TC_QuickJitForLoops: 1
DOTNET_ReadyToRun: 0
```

Переменная окружения для включения операций AVX во всей кодовой базе. В зависимости от вашего процессора, это может ухудшить производительность, а не улучшить ее, в противном случае это может улучшить производительность atmos.
```
ROBUST_NUMERICS_AVX: true
```

Вы можете установить переменные окружения из настроек WatchDog, см. ниже.

## Уровень 4: Производственный сервер c Watchdog

Этот уровень предназначен для тех, кто работает с собственной кодовой базой и сервером, и/или для тех, кто хочет более надежное решение для хостинга.

[`SS14.Watchdog`](https://github.com/space-wizards/SS14.Watchdog/) (кодовое имя Ian) - это наш помощник для хостинга, похожий на TGS для BYOND (но гораздо более простой на данный момент). Он обрабатывает автообновления, мониторинг, автоматические перезагрузки и администрирование. Мы рекомендуем вам использовать его для правильного развертывания.

### Установка
[`Ссылайтесь на это`](https://docs.spacestation14.com/ru/server-hosting/setting-up-ss14-watchdog.html) для получения инструкций по сборке и настройке Watchdog.

### Конфигурация сборки сервера

Чтобы запустить игру, пусковой установке необходимо загрузить бинарный файл клиента. Он получает информацию об этом клиентском бинарнике с игрового сервера через информационный API.

Информация, возвращаемая из этого API, настраивается двумя способами: `build.json` и `build.*` конфигурационные переменные.

`build.json` - это файл, который система сборки автоматически помещает рядом с исполняемым файлом сервера. Так сервер узнает информацию о сборке, когда просто загружает zip-архив голого сервера (обратите внимание, что это НЕ делает `package_release_build.py`, поскольку он полагается на дополнительную информацию о сборке. `gen_build_info.py` делает это на отдельном шаге)

Второй вариант - указание конфигурационных переменных (из командной строки или файла конфигурации, оба варианта работают):
```toml
[build]
# «Идентификатор» вашего сервера. Он используется программой запуска для управления установками.
# Старайтесь, чтобы он был уникальным для разных кодовых баз.
# В противном случае (или при наличии злоумышленника) ничего не сломается,
# но программа запуска будет вынуждена скачивать файлы чаще, чем это необходимо.
fork_id = «»

# Строка версии текущей сборки, запущенной на сервере.
# Это просто побуждает программу запуска к повторной загрузке, если она отличается.
version = «»

# Версия движка для загрузки.
# Версии движков размещаются у нас и, вероятно, останутся навсегда.
# По крайней мере, до тех пор, пока не будет обнаружено, что они уязвимы к каким-либо эксплойтам безопасности, тогда мы можем их удалить.
engine_version = «»

# Место загрузки всей клиентской сборки в zip-архиве, в виде ссылки HTTP/HTTPS.
download_url = «»

# SHA256-хэш zip-файлов клиента, указанных выше.
hash = «»
```

Обратите внимание, что `SS14.Watchdog` определяет *большую часть* этого за вас, если вы настроили его на автоматическое обновление (в зависимости от поставщика обновлений). В частности, он не может предоставить версию `engine_version` или `fork_id`, так что лучше всего указать первую в build.json (ваша система сборки должна быть не мусорной для этого), а вторую в файле конфигурации.

## Уровень 5: Большой сервер
Вещи, которые не являются необходимыми для небольших/частных серверов, но настоятельно рекомендуются для форков или больших производственных серверов.

### Расширенная переадресация портов

При желании вы можете засунуть HTTP status API за обратный прокси. Это рекомендуется для производственных серверов, так как тогда вы можете сделать HTTPS (пробросить его за nginx и включить HTTPS). Обратите внимание, что в этом случае вы должны установить конфигурационную переменную `status.connectaddress`, чтобы указать UDP-адрес, к которому должен подключаться основной неткод. Это должно выглядеть следующим образом: `udp://server.spacestation14.io:1212` (для нашего сервера, очевидно, замените своими параметрами). 


### Настройка PostgreSQL

SS14 использует базу данных SQL для хранения данных сервера, таких как слоты игроков. По умолчанию автоматически используется база данных **SQLite**, которой достаточно для локального тестирования и небольших серверов. Однако если вам нужна возможность разделить базу данных между несколькими серверами, сервер также поддерживает подключение к **PostgreSQL**.
Поддержка MySQL/MariaDB в настоящее время не планируется, но мы будем принимать предложения.

Соответствующие свойства конфигурации, а также значения по умолчанию:

```toml
# Файл конфигурации сервера
[database]
# Тип используемой базы данных. В настоящее время это может быть «sqlite» или «postgres».
engine = «sqlite»

# Путь для хранения базы данных при использовании SQLite. Обратите внимание, что это НЕ путь к диску.
# Это относительно каталога данных сервера, который указывается параметром --data-dir при запуске сервера из команды (или автоматически устанавливается SS14.Watchdog)
sqlite_dbpath = «preferences.db»

# Конфигурация базы данных PostgreSQL, все говорит само за себя.
pg_host = «localhost»
pg_port = 5432
pg_database = «ss14»
pg_username = «»
pg_password = «»
```

Игровой сервер автоматически выполняет миграцию при запуске, вам не нужно делать это вручную.

### Метрика Prometheus

SS14 поддерживаеn [Prometheus](https://prometheus.io/), с помощью которого вы можете создавать причудливые графики в [Grafana](https://grafana.com/) или тому подобное. Вы можете найти наши графики Grafana [здесь](../../community/infrastructure-reference/grafana-dashboards.md), если они вдруг окажутся полезными.

Чтобы настроить это, вы можете использовать следующие переменные конфигурации:

```toml
[metrics]
enabled = true
# Адрес для привязки сервера метрик, используйте «*» для всех локальных интерфейсов
host = «localhost»
# Порт для привязки сервера метрик
порт = 44880
```

Затем вы можете скрапировать это с помощью следующей конфигурации Prometheus (например):

```yml
global:
  scrape_interval: 1s
  интервал_оценки: 1с

scrape_configs:
  - имя_работы: «wizards_den_us_west»
    static_configs:
      - targets: [«localhost:44880»]
```

### Логирование через Loki

SS14 также поддерживает отправку структурированных данных логов в [Loki](https://grafana.com/oss/loki/). Поскольку это современное DevOps-дерьмо, на сайте не сказано, что это на самом деле делает, но в сочетании с Grafana вы можете просматривать и фильтровать логи более разумным способом, чем голые текстовые файлы.

Нет, вам не нужно настраивать Promtail, чтобы это работало. SS14 напрямую передает данные в Loki.

Чтобы настроить это, вы можете использовать следующие переменные конфигурации:

```toml
[loki]
enabled = true
# HTTP-адрес сервера Loki.
address = «http://localhost:3100»
# Имя этого сервера, включаемое во все сообщения журнала.
name = «wizards_den_us_west»
# Параметры для HTTP Basic-аутентификации, если Loki настроен за ней.
# Если оставить эти параметры, аутентификация не будет производиться.
# username = «»
# пароль = «»
```

## Устранение неполадок

### Невозможно разместить сервер х хабе / люди не могут подключиться

Люди не могут подключиться к вашему серверу ИЛИ вы получаете следующую ошибку в консоли сервера:

```
[ERRO] hub: Error status while advertising server: [UnprocessableEntity] «Unable to contact status address»
```

Это означает, что ваш сервер недоступен из внешнего интернета. Убедитесь, что вы следовали руководству по [открытию портов](../../server-hosting/port-forwarding.md).

### SS14.Watchdog

#### Сервер перезапускается каждые 30 секунд.

Это означает, что сервер некорректно взаимодействует с Watchdog, и Watchdog считает, что сервер заблокирован или что-то подобное. Это происходит, если `BaseUrl` в конфигурации watchdog установлен неверно или иным образом недоступен игровому серверу.

#### `System.IO.FileNotFoundException: Could not load file or assembly 'Mono.Posix.NETStandard, Version=1.0.0.0, Culture=neutral` (...)

Текущая рабочая теория заключается в том, что это вызвано неправильными настройками `dotnet publish`.
Приведенный ниже набор результатов тестирования должен помочь объяснить это.

```
dotnet publish -c Release -r linux-x64 --no-self-contained SS14.Watchdog -o test
 РЕЗУЛЬТАТ: Mono.Posix.NETStandard.dll включена, System.dll не включена (как и ожидалось)

dotnet publish -c Release -r linux-x64 SS14.Watchdog -o test
 РЕЗУЛЬТАТ: Mono.Posix.NETStandard.dll включена, System.dll включена

dotnet publish -c Release SS14.Watchdog -o test
 РЕЗУЛЬТАТ: Mono.Posix.NETStandard.dll не включена, System.dll не включена
```

Поскольку Watchdog использует `Mono.Posix.NETStandard.dll` для пометки исполняемых файлов как исполняемых в Linux и Mac OS X, важно иметь его под рукой в этих ОС.

### Запуск сервера на MacOS или Linux

Откройте терминал в распакованном каталоге сборки (в нем должен быть файл Robust.Server).
Введите `./Robust.Server` и нажмите Enter. Если вы видите, что на экран выводится куча всякой всячины, и при этом нет сообщения об ошибке, значит, сервер запущен.

### Дополнительное устранение проблем

[Типичные проблемы](../tips/troubleshooting-faq.md#server)

## Полезные ссылки
Все важные ссылки на этой странице в одном удобном месте.
* [Помощь в конфигурации сервера](../tips/config-file-reference.md)
* [.NET 8 Runtime](https://dotnet.microsoft.com/download) (Также входит в полный .NET 8 SDK)
* [ASP.NET Core 8 Runtime](https://dotnet.microsoft.com/ru-us/download/dotnet/8.0) (Также включено в полный .NET 8 SDK)
* [SS14.Watchdog](https://github.com/space-wizards/SS14.Watchdog/)
* [Официальные сборки](https://central.spacestation14.io/builds/wizards/builds.html)
* [Референс инфраструктуры Wizard's Den](../../community/infrastructure-reference/wizards-den-infrastructure.md) (спецификации сервера)
* [Правила хаба](../../community/space-wizards-hub-rules.md)
* [Открытие портов](../../server-hosting/port-forwarding.md)